# @format

name: Deploy NextJS to VPS

on:
    push:
        branches:
            - main # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ main

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: production
        steps:
            - name: Deploy to VPS via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è NextJS"

                      export NVM_DIR="$HOME/.nvm"
                      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                      nvm use 22
                      echo "‚úÖ Node.js –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

                      cd /var/www/client.top24.kz
                      echo "‚úÖ –ü–µ—Ä–µ—à–ª–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"

                      echo "‚ö° –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
                      git fetch --all
                      git reset --hard origin/main
                      git pull origin main || { echo "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!"; exit 1; }
                      echo "‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ–±–Ω–æ–≤–ª—ë–Ω"

                      echo "‚ö° –£–¥–∞–ª—è–µ–º .next, npded_modules, ..."
                      rm -rf .next node_modules package-lock.json
                      echo "‚úÖ .next node_modules package-lock.json —É–¥–∞–ª–µ–Ω—ã"

                      echo "‚ö° –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
                      npm install --verbose || { echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!"; exit 1; }
                      echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

                      echo "‚ö° –ë–∏–ª–¥–∏–º –ø—Ä–æ–µ–∫—Ç..."
                      npm run build || { echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞!"; exit 1; }
                      echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

                      echo "‚ö° –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ PM2..."
                      pm2 restart client || { echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ PM2!"; exit 1; }
                      echo "‚úÖ –î–µ–ø–ª–æ–π NextJS –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
